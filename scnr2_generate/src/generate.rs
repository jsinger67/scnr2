use proc_macro2::TokenStream;
use quote::quote;
use syn::parse2;

use crate::{
    character_classes::CharacterClasses, nfa::Nfa, scanner_data::ScannerData,
    scanner_mode::ScannerMode,
};

/// This function generates the scanner code from the input token stream.
/// It parses the input token stream into a `ScannerData` struct and then generates the scanner
/// code.
/// It returns a `TokenStream` containing the generated code.
/// The input token stream is expected to contain the scanner definition, including the regex
/// patterns and actions.
/// The macro syntax is expected to be used in the following way:
/// ```ignore
/// use scnr_macro::scanner;
///
/// scanner! {
///     ExampleScanner {
///         mode INITIAL {
///             token r"\r\n|\r|\n" => 1;
///             token r"[\s--\r\n]+" => 2;
///             token r"//.*(\r\n|\r|\n)?" => 3;
///             token r"/\*([^*]|\*[^/])*\*/" => 4;
///             token r#"""# => 8;
///             token r"Hello" => 9;
///             token r"World" => 10;
///             token r"World" => 11 followed by r"!";
///             token r"!" => 12 not followed by r"!";
///             token r"[a-zA-Z_]\w*" => 13;
///             token r"." => 14;
///
///             transition 8 => STRING;
///         }
///         mode STRING {
///             token r#"\\[\"\\bfnt]"# => 5;
///             token r"\\[\s--\n\r]*\r?\n" => 6;
///             token r#"[^\"\]+"# => 7;
///             token r#"""# => 8;
///             token r"." => 14;
///
///             transition 8 => INITIAL;
//          }
///     }
/// }
/// ```
/// where there must be at least one scanner mode with at least one `token` entry.
/// A `token` entry is a regex pattern followed by an arrow and a token type number.
/// Optional `not` and `followed by` modifiers can be used to specify positive and negative
/// lookaheads.
/// Zero or more `transition` entries can exist.
/// The `transition` entries are tuples of the token type numbers and the new scanner mode name.
///
/// The generated code will include the scanner implementation.
/// The generated scanner in this example will be a struct named `ExampleScanner` which implements
/// the `ScannerTrait`.
pub fn generate(input: TokenStream) -> TokenStream {
    let scanner_data: ScannerData = parse2(input).expect("Failed to parse input");
    let scanner_modes: Vec<ScannerMode> = scanner_data
        .build_scanner_modes()
        .expect("Failed to build scanner modes");

    // Generate NFAs for each scanner mode
    let mut nfas = scanner_modes
        .iter()
        .map(|mode| {
            // Build the NFA for each pattern in the scanner mode
            Nfa::build_from_patterns(&mode.patterns).expect("Failed to build NFA for pattern")
        })
        .collect::<Vec<_>>();

    let mut character_classes = CharacterClasses::new();
    // For each NFA, generate the character classes
    for nfa in &nfas {
        nfa.collect_character_classes(&mut character_classes)
    }
    // Generate disjoint character classes
    character_classes.create_disjoint_character_classes();
    // Convert the NFA to use disjoint character classes
    for nfa in &mut nfas {
        nfa.convert_to_disjoint_character_classes(&character_classes);
    }

    // Make the scanner name an syn::Ident
    let scanner_name = syn::Ident::new(&scanner_data.name, proc_macro2::Span::call_site());
    let match_function_code = character_classes.generate("match_function");

    let output = quote! {
        struct #scanner_name {}

        impl #scanner_name {
            fn new() -> Self {
                #scanner_name {}
            }
            #match_function_code
        }
    };

    output
}

#[cfg(test)]
mod tests {
    use std::io::Write;

    use super::*;

    use crate::Result;
    use std::path::Path;

    use std::process::Command;

    /// Tries to format the source code of a given file.
    fn try_format(path_to_file: &Path) -> Result<()> {
        Command::new("rustfmt")
            .args([path_to_file])
            .status()
            .map(|_| ())
            .map_err(|e| {
                std::io::Error::new(e.kind(), format!("Failed to format file: {}", e)).into()
            })
    }

    #[test]
    fn test_generate() {
        let input = quote::quote! {
            HelloWorld {
                mode INITIAL {
                    token r"\r\n|\r|\n" => 1;
                    token r"[\s--\r\n]+" => 2;
                    token r"//.*(\r\n|\r|\n)?" => 3;
                    token r"/\*([^*]|\*[^/])*\*/" => 4;
                    token r#"""# => 8;
                    token r"Hello" => 9;
                    token r"World" => 10;
                    token r"World" => 11 followed by r"!";
                    token r"!" => 12 not followed by r"!";
                    token r"[a-zA-Z_]\w*" => 13;
                    token r"." => 14;

                    transition 8 => STRING;
                }
                mode STRING {
                    token r#"\\[\"\\bfnt]"# => 5;
                    token r"\\[\s--\r\n]*\r?\n" => 6;
                    token r#"[^\"\\]+"# => 7;
                    token r#"""# => 8;
                    token r"." => 14;

                    transition 8 => INITIAL;
                }
            }
        };
        let code = generate(input).to_string();

        // Create a temporary file
        let mut temp_file =
            tempfile::NamedTempFile::new().expect("Failed to create temporary file");

        // Write the generated code to the temporary file
        temp_file
            .write_all(code.as_bytes())
            .expect("Failed to write to temporary file");

        // Optionally, print the file path for debugging
        println!("Temporary file created at: {:?}", temp_file.path());

        // Format the file (if needed)
        try_format(temp_file.path()).expect("Failed to format the temporary file");

        // Load the formatted code and convert possible \r\n to \n for easier comparison
        let formatted_code = std::fs::read_to_string(temp_file.path())
            .expect("Failed to read the formatted temporary file")
            .replace("\r\n", "\n");

        let expected_code = r#"struct HelloWorld {}
impl HelloWorld {
    fn new() -> Self {
        HelloWorld {}
    }
    #[allow(clippy::manual_is_ascii_check, dead_code)]
    pub(crate) fn match_function(char_class: usize, c: char) -> bool {
        use std::cmp::Ordering;
        static CHAR_CLASS_TABLE: &[&[std::ops::RangeInclusive<char>]] = &[
            &['\r'..='\r'],
            &['\n'..='\n'],
            {
                &[
                    '\t'..='\t',
                    '\u{b}'..='\u{c}',
                    ' '..=' ',
                    '\u{85}'..='\u{85}',
                    '\u{a0}'..='\u{a0}',
                    '\u{1680}'..='\u{1680}',
                    '\u{2000}'..='\u{200a}',
                    '\u{2028}'..='\u{2029}',
                    '\u{202f}'..='\u{202f}',
                    '\u{205f}'..='\u{205f}',
                    '\u{3000}'..='\u{3000}',
                ]
            },
            &['/'..='/'],
            { &['\0'..='\t', '\u{b}'..='\u{10ffff}'] },
            &['*'..='*'],
            { &['\0'..=')', '+'..='\u{10ffff}'] },
            { &['\0'..='.', '0'..='\u{10ffff}'] },
            &['"'..='"'],
            &['H'..='H'],
            &['e'..='e'],
            &['l'..='l'],
            &['o'..='o'],
            &['W'..='W'],
            &['r'..='r'],
            &['d'..='d'],
            &['!'..='!'],
            { &['A'..='Z', '_'..='_', 'a'..='z'] },
            {
                &[
                    '0'..='9',
                    'A'..='Z',
                    '_'..='_',
                    'a'..='z',
                    'Âª'..='Âª',
                    'Âµ'..='Âµ',
                    'Âº'..='Âº',
                    'Ã€'..='Ã–',
                    'Ã˜'..='Ã¶',
                    'Ã¸'..='Ë',
                    'Ë†'..='Ë‘',
                    'Ë '..='Ë¤',
                    'Ë¬'..='Ë¬',
                    'Ë®'..='Ë®',
                    '\u{300}'..='Í´',
                    'Í¶'..='Í·',
                    'Íº'..='Í½',
                    'Í¿'..='Í¿',
                    'Î†'..='Î†',
                    'Îˆ'..='ÎŠ',
                    'ÎŒ'..='ÎŒ',
                    'Î'..='Î¡',
                    'Î£'..='Ïµ',
                    'Ï·'..='Ò',
                    '\u{483}'..='Ô¯',
                    'Ô±'..='Õ–',
                    'Õ™'..='Õ™',
                    'Õ '..='Öˆ',
                    '\u{591}'..='\u{5bd}',
                    '\u{5bf}'..='\u{5bf}',
                    '\u{5c1}'..='\u{5c2}',
                    '\u{5c4}'..='\u{5c5}',
                    '\u{5c7}'..='\u{5c7}',
                    '×'..='×ª',
                    '×¯'..='×²',
                    '\u{610}'..='\u{61a}',
                    'Ø '..='Ù©',
                    'Ù®'..='Û“',
                    'Û•'..='\u{6dc}',
                    '\u{6df}'..='\u{6e8}',
                    '\u{6ea}'..='Û¼',
                    'Û¿'..='Û¿',
                    'Ü'..='\u{74a}',
                    'İ'..='Ş±',
                    'ß€'..='ßµ',
                    'ßº'..='ßº',
                    '\u{7fd}'..='\u{7fd}',
                    'à €'..='\u{82d}',
                    'à¡€'..='\u{85b}',
                    'à¡ '..='à¡ª',
                    'à¡°'..='à¢‡',
                    'à¢‰'..='à¢',
                    '\u{897}'..='\u{8e1}',
                    '\u{8e3}'..='\u{963}',
                    'à¥¦'..='à¥¯',
                    'à¥±'..='à¦ƒ',
                    'à¦…'..='à¦Œ',
                    'à¦'..='à¦',
                    'à¦“'..='à¦¨',
                    'à¦ª'..='à¦°',
                    'à¦²'..='à¦²',
                    'à¦¶'..='à¦¹',
                    '\u{9bc}'..='\u{9c4}',
                    'à§‡'..='à§ˆ',
                    'à§‹'..='à§',
                    '\u{9d7}'..='\u{9d7}',
                    'à§œ'..='à§',
                    'à§Ÿ'..='\u{9e3}',
                    'à§¦'..='à§±',
                    'à§¼'..='à§¼',
                    '\u{9fe}'..='\u{9fe}',
                    '\u{a01}'..='à¨ƒ',
                    'à¨…'..='à¨Š',
                    'à¨'..='à¨',
                    'à¨“'..='à¨¨',
                    'à¨ª'..='à¨°',
                    'à¨²'..='à¨³',
                    'à¨µ'..='à¨¶',
                    'à¨¸'..='à¨¹',
                    '\u{a3c}'..='\u{a3c}',
                    'à¨¾'..='\u{a42}',
                    '\u{a47}'..='\u{a48}',
                    '\u{a4b}'..='\u{a4d}',
                    '\u{a51}'..='\u{a51}',
                    'à©™'..='à©œ',
                    'à©'..='à©',
                    'à©¦'..='\u{a75}',
                    '\u{a81}'..='àªƒ',
                    'àª…'..='àª',
                    'àª'..='àª‘',
                    'àª“'..='àª¨',
                    'àªª'..='àª°',
                    'àª²'..='àª³',
                    'àªµ'..='àª¹',
                    '\u{abc}'..='\u{ac5}',
                    '\u{ac7}'..='à«‰',
                    'à«‹'..='\u{acd}',
                    'à«'..='à«',
                    'à« '..='\u{ae3}',
                    'à«¦'..='à«¯',
                    'à«¹'..='\u{aff}',
                    '\u{b01}'..='à¬ƒ',
                    'à¬…'..='à¬Œ',
                    'à¬'..='à¬',
                    'à¬“'..='à¬¨',
                    'à¬ª'..='à¬°',
                    'à¬²'..='à¬³',
                    'à¬µ'..='à¬¹',
                    '\u{b3c}'..='\u{b44}',
                    'à­‡'..='à­ˆ',
                    'à­‹'..='\u{b4d}',
                    '\u{b55}'..='\u{b57}',
                    'à­œ'..='à­',
                    'à­Ÿ'..='\u{b63}',
                    'à­¦'..='à­¯',
                    'à­±'..='à­±',
                    '\u{b82}'..='à®ƒ',
                    'à®…'..='à®Š',
                    'à®'..='à®',
                    'à®’'..='à®•',
                    'à®™'..='à®š',
                    'à®œ'..='à®œ',
                    'à®'..='à®Ÿ',
                    'à®£'..='à®¤',
                    'à®¨'..='à®ª',
                    'à®®'..='à®¹',
                    '\u{bbe}'..='à¯‚',
                    'à¯†'..='à¯ˆ',
                    'à¯Š'..='\u{bcd}',
                    'à¯'..='à¯',
                    '\u{bd7}'..='\u{bd7}',
                    'à¯¦'..='à¯¯',
                    '\u{c00}'..='à°Œ',
                    'à°'..='à°',
                    'à°’'..='à°¨',
                    'à°ª'..='à°¹',
                    '\u{c3c}'..='à±„',
                    '\u{c46}'..='\u{c48}',
                    '\u{c4a}'..='\u{c4d}',
                    '\u{c55}'..='\u{c56}',
                    'à±˜'..='à±š',
                    'à±'..='à±',
                    'à± '..='\u{c63}',
                    'à±¦'..='à±¯',
                    'à²€'..='à²ƒ',
                    'à²…'..='à²Œ',
                    'à²'..='à²',
                    'à²’'..='à²¨',
                    'à²ª'..='à²³',
                    'à²µ'..='à²¹',
                    '\u{cbc}'..='à³„',
                    '\u{cc6}'..='\u{cc8}',
                    '\u{cca}'..='\u{ccd}',
                    '\u{cd5}'..='\u{cd6}',
                    'à³'..='à³',
                    'à³ '..='\u{ce3}',
                    'à³¦'..='à³¯',
                    'à³±'..='à³³',
                    '\u{d00}'..='à´Œ',
                    'à´'..='à´',
                    'à´’'..='\u{d44}',
                    'àµ†'..='àµˆ',
                    'àµŠ'..='àµ',
                    'àµ”'..='\u{d57}',
                    'àµŸ'..='\u{d63}',
                    'àµ¦'..='àµ¯',
                    'àµº'..='àµ¿',
                    '\u{d81}'..='à¶ƒ',
                    'à¶…'..='à¶–',
                    'à¶š'..='à¶±',
                    'à¶³'..='à¶»',
                    'à¶½'..='à¶½',
                    'à·€'..='à·†',
                    '\u{dca}'..='\u{dca}',
                    '\u{dcf}'..='\u{dd4}',
                    '\u{dd6}'..='\u{dd6}',
                    'à·˜'..='\u{ddf}',
                    'à·¦'..='à·¯',
                    'à·²'..='à·³',
                    'à¸'..='\u{e3a}',
                    'à¹€'..='\u{e4e}',
                    'à¹'..='à¹™',
                    'àº'..='àº‚',
                    'àº„'..='àº„',
                    'àº†'..='àºŠ',
                    'àºŒ'..='àº£',
                    'àº¥'..='àº¥',
                    'àº§'..='àº½',
                    'à»€'..='à»„',
                    'à»†'..='à»†',
                    '\u{ec8}'..='\u{ece}',
                    'à»'..='à»™',
                    'à»œ'..='à»Ÿ',
                    'à¼€'..='à¼€',
                    '\u{f18}'..='\u{f19}',
                    'à¼ '..='à¼©',
                    '\u{f35}'..='\u{f35}',
                    '\u{f37}'..='\u{f37}',
                    '\u{f39}'..='\u{f39}',
                    'à¼¾'..='à½‡',
                    'à½‰'..='à½¬',
                    '\u{f71}'..='\u{f84}',
                    '\u{f86}'..='\u{f97}',
                    '\u{f99}'..='\u{fbc}',
                    '\u{fc6}'..='\u{fc6}',
                    'á€€'..='á‰',
                    'á'..='\u{109d}',
                    'á‚ '..='áƒ…',
                    'áƒ‡'..='áƒ‡',
                    'áƒ'..='áƒ',
                    'áƒ'..='áƒº',
                    'áƒ¼'..='á‰ˆ',
                    'á‰Š'..='á‰',
                    'á‰'..='á‰–',
                    'á‰˜'..='á‰˜',
                    'á‰š'..='á‰',
                    'á‰ '..='áŠˆ',
                    'áŠŠ'..='áŠ',
                    'áŠ'..='áŠ°',
                    'áŠ²'..='áŠµ',
                    'áŠ¸'..='áŠ¾',
                    'á‹€'..='á‹€',
                    'á‹‚'..='á‹…',
                    'á‹ˆ'..='á‹–',
                    'á‹˜'..='áŒ',
                    'áŒ’'..='áŒ•',
                    'áŒ˜'..='áš',
                    '\u{135d}'..='\u{135f}',
                    'á€'..='á',
                    'á '..='áµ',
                    'á¸'..='á½',
                    'á'..='á™¬',
                    'á™¯'..='á™¿',
                    'áš'..='ášš',
                    'áš '..='á›ª',
                    'á›®'..='á›¸',
                    'áœ€'..='\u{1715}',
                    'áœŸ'..='\u{1734}',
                    'á€'..='\u{1753}',
                    'á '..='á¬',
                    'á®'..='á°',
                    '\u{1772}'..='\u{1773}',
                    'á€'..='\u{17d3}',
                    'áŸ—'..='áŸ—',
                    'áŸœ'..='\u{17dd}',
                    'áŸ '..='áŸ©',
                    '\u{180b}'..='\u{180d}',
                    '\u{180f}'..='á ™',
                    'á  '..='á¡¸',
                    'á¢€'..='á¢ª',
                    'á¢°'..='á£µ',
                    'á¤€'..='á¤',
                    '\u{1920}'..='á¤«',
                    'á¤°'..='\u{193b}',
                    'á¥†'..='á¥­',
                    'á¥°'..='á¥´',
                    'á¦€'..='á¦«',
                    'á¦°'..='á§‰',
                    'á§'..='á§™',
                    'á¨€'..='\u{1a1b}',
                    'á¨ '..='\u{1a5e}',
                    '\u{1a60}'..='\u{1a7c}',
                    '\u{1a7f}'..='áª‰',
                    'áª'..='áª™',
                    'áª§'..='áª§',
                    '\u{1ab0}'..='\u{1ace}',
                    '\u{1b00}'..='á­Œ',
                    'á­'..='á­™',
                    '\u{1b6b}'..='\u{1b73}',
                    '\u{1b80}'..='\u{1bf3}',
                    'á°€'..='\u{1c37}',
                    'á±€'..='á±‰',
                    'á±'..='á±½',
                    'á²€'..='á²Š',
                    'á²'..='á²º',
                    'á²½'..='á²¿',
                    '\u{1cd0}'..='\u{1cd2}',
                    '\u{1cd4}'..='á³º',
                    'á´€'..='á¼•',
                    'á¼˜'..='á¼',
                    'á¼ '..='á½…',
                    'á½ˆ'..='á½',
                    'á½'..='á½—',
                    'á½™'..='á½™',
                    'á½›'..='á½›',
                    'á½'..='á½',
                    'á½Ÿ'..='á½½',
                    'á¾€'..='á¾´',
                    'á¾¶'..='á¾¼',
                    'á¾¾'..='á¾¾',
                    'á¿‚'..='á¿„',
                    'á¿†'..='á¿Œ',
                    'á¿'..='á¿“',
                    'á¿–'..='á¿›',
                    'á¿ '..='á¿¬',
                    'á¿²'..='á¿´',
                    'á¿¶'..='á¿¼',
                    '\u{200c}'..='\u{200d}',
                    'â€¿'..='â€',
                    'â”'..='â”',
                    'â±'..='â±',
                    'â¿'..='â¿',
                    'â‚'..='â‚œ',
                    '\u{20d0}'..='\u{20f0}',
                    'â„‚'..='â„‚',
                    'â„‡'..='â„‡',
                    'â„Š'..='â„“',
                    'â„•'..='â„•',
                    'â„™'..='â„',
                    'â„¤'..='â„¤',
                    'â„¦'..='â„¦',
                    'â„¨'..='â„¨',
                    'â„ª'..='â„­',
                    'â„¯'..='â„¹',
                    'â„¼'..='â„¿',
                    'â……'..='â…‰',
                    'â…'..='â…',
                    'â… '..='â†ˆ',
                    'â’¶'..='â“©',
                    'â°€'..='â³¤',
                    'â³«'..='â³³',
                    'â´€'..='â´¥',
                    'â´§'..='â´§',
                    'â´­'..='â´­',
                    'â´°'..='âµ§',
                    'âµ¯'..='âµ¯',
                    '\u{2d7f}'..='â¶–',
                    'â¶ '..='â¶¦',
                    'â¶¨'..='â¶®',
                    'â¶°'..='â¶¶',
                    'â¶¸'..='â¶¾',
                    'â·€'..='â·†',
                    'â·ˆ'..='â·',
                    'â·'..='â·–',
                    'â·˜'..='â·',
                    '\u{2de0}'..='\u{2dff}',
                    'â¸¯'..='â¸¯',
                    'ã€…'..='ã€‡',
                    'ã€¡'..='\u{302f}',
                    'ã€±'..='ã€µ',
                    'ã€¸'..='ã€¼',
                    'ã'..='ã‚–',
                    '\u{3099}'..='\u{309a}',
                    'ã‚'..='ã‚Ÿ',
                    'ã‚¡'..='ãƒº',
                    'ãƒ¼'..='ãƒ¿',
                    'ã„…'..='ã„¯',
                    'ã„±'..='ã†',
                    'ã† '..='ã†¿',
                    'ã‡°'..='ã‡¿',
                    'ã€'..='ä¶¿',
                    'ä¸€'..='ê’Œ',
                    'ê“'..='ê“½',
                    'ê”€'..='ê˜Œ',
                    'ê˜'..='ê˜«',
                    'ê™€'..='\u{a672}',
                    '\u{a674}'..='\u{a67d}',
                    'ê™¿'..='\u{a6f1}',
                    'êœ—'..='êœŸ',
                    'êœ¢'..='êˆ',
                    'ê‹'..='êŸ',
                    'êŸ'..='êŸ‘',
                    'êŸ“'..='êŸ“',
                    'êŸ•'..='êŸœ',
                    'êŸ²'..='ê §',
                    '\u{a82c}'..='\u{a82c}',
                    'ê¡€'..='ê¡³',
                    'ê¢€'..='\u{a8c5}',
                    'ê£'..='ê£™',
                    '\u{a8e0}'..='ê£·',
                    'ê£»'..='ê£»',
                    'ê£½'..='\u{a92d}',
                    'ê¤°'..='\u{a953}',
                    'ê¥ '..='ê¥¼',
                    '\u{a980}'..='\u{a9c0}',
                    'ê§'..='ê§™',
                    'ê§ '..='ê§¾',
                    'ê¨€'..='\u{aa36}',
                    'ê©€'..='ê©',
                    'ê©'..='ê©™',
                    'ê© '..='ê©¶',
                    'ê©º'..='ê«‚',
                    'ê«›'..='ê«',
                    'ê« '..='ê«¯',
                    'ê«²'..='\u{aaf6}',
                    'ê¬'..='ê¬†',
                    'ê¬‰'..='ê¬',
                    'ê¬‘'..='ê¬–',
                    'ê¬ '..='ê¬¦',
                    'ê¬¨'..='ê¬®',
                    'ê¬°'..='ê­š',
                    'ê­œ'..='ê­©',
                    'ê­°'..='ê¯ª',
                    'ê¯¬'..='\u{abed}',
                    'ê¯°'..='ê¯¹',
                    'ê°€'..='í£',
                    'í°'..='íŸ†',
                    'íŸ‹'..='íŸ»',
                    'ï¤€'..='ï©­',
                    'ï©°'..='ï«™',
                    'ï¬€'..='ï¬†',
                    'ï¬“'..='ï¬—',
                    'ï¬'..='ï¬¨',
                    'ï¬ª'..='ï¬¶',
                    'ï¬¸'..='ï¬¼',
                    'ï¬¾'..='ï¬¾',
                    'ï­€'..='ï­',
                    'ï­ƒ'..='ï­„',
                    'ï­†'..='ï®±',
                    'ï¯“'..='ï´½',
                    'ïµ'..='ï¶',
                    'ï¶’'..='ï·‡',
                    'ï·°'..='ï·»',
                    '\u{fe00}'..='\u{fe0f}',
                    '\u{fe20}'..='\u{fe2f}',
                    'ï¸³'..='ï¸´',
                    'ï¹'..='ï¹',
                    'ï¹°'..='ï¹´',
                    'ï¹¶'..='ï»¼',
                    'ï¼'..='ï¼™',
                    'ï¼¡'..='ï¼º',
                    'ï¼¿'..='ï¼¿',
                    'ï½'..='ï½š',
                    'ï½¦'..='ï¾¾',
                    'ï¿‚'..='ï¿‡',
                    'ï¿Š'..='ï¿',
                    'ï¿’'..='ï¿—',
                    'ï¿š'..='ï¿œ',
                    'ğ€€'..='ğ€‹',
                    'ğ€'..='ğ€¦',
                    'ğ€¨'..='ğ€º',
                    'ğ€¼'..='ğ€½',
                    'ğ€¿'..='ğ',
                    'ğ'..='ğ',
                    'ğ‚€'..='ğƒº',
                    'ğ…€'..='ğ…´',
                    '\u{101fd}'..='\u{101fd}',
                    'ğŠ€'..='ğŠœ',
                    'ğŠ '..='ğ‹',
                    '\u{102e0}'..='\u{102e0}',
                    'ğŒ€'..='ğŒŸ',
                    'ğŒ­'..='ğŠ',
                    'ğ'..='\u{1037a}',
                    'ğ€'..='ğ',
                    'ğ '..='ğƒ',
                    'ğˆ'..='ğ',
                    'ğ‘'..='ğ•',
                    'ğ€'..='ğ’',
                    'ğ’ '..='ğ’©',
                    'ğ’°'..='ğ““',
                    'ğ“˜'..='ğ“»',
                    'ğ”€'..='ğ”§',
                    'ğ”°'..='ğ•£',
                    'ğ•°'..='ğ•º',
                    'ğ•¼'..='ğ–Š',
                    'ğ–Œ'..='ğ–’',
                    'ğ–”'..='ğ–•',
                    'ğ–—'..='ğ–¡',
                    'ğ–£'..='ğ–±',
                    'ğ–³'..='ğ–¹',
                    'ğ–»'..='ğ–¼',
                    'ğ—€'..='ğ—³',
                    'ğ˜€'..='ğœ¶',
                    'ğ€'..='ğ•',
                    'ğ '..='ğ§',
                    'ğ€'..='ğ…',
                    'ğ‡'..='ğ°',
                    'ğ²'..='ğº',
                    'ğ €'..='ğ …',
                    'ğ ˆ'..='ğ ˆ',
                    'ğ Š'..='ğ µ',
                    'ğ ·'..='ğ ¸',
                    'ğ ¼'..='ğ ¼',
                    'ğ ¿'..='ğ¡•',
                    'ğ¡ '..='ğ¡¶',
                    'ğ¢€'..='ğ¢',
                    'ğ£ '..='ğ£²',
                    'ğ£´'..='ğ£µ',
                    'ğ¤€'..='ğ¤•',
                    'ğ¤ '..='ğ¤¹',
                    'ğ¦€'..='ğ¦·',
                    'ğ¦¾'..='ğ¦¿',
                    'ğ¨€'..='\u{10a03}',
                    '\u{10a05}'..='\u{10a06}',
                    '\u{10a0c}'..='ğ¨“',
                    'ğ¨•'..='ğ¨—',
                    'ğ¨™'..='ğ¨µ',
                    '\u{10a38}'..='\u{10a3a}',
                    '\u{10a3f}'..='\u{10a3f}',
                    'ğ© '..='ğ©¼',
                    'ğª€'..='ğªœ',
                    'ğ«€'..='ğ«‡',
                    'ğ«‰'..='\u{10ae6}',
                    'ğ¬€'..='ğ¬µ',
                    'ğ­€'..='ğ­•',
                    'ğ­ '..='ğ­²',
                    'ğ®€'..='ğ®‘',
                    'ğ°€'..='ğ±ˆ',
                    'ğ²€'..='ğ²²',
                    'ğ³€'..='ğ³²',
                    'ğ´€'..='\u{10d27}',
                    'ğ´°'..='ğ´¹',
                    'ğµ€'..='ğµ¥',
                    '\u{10d69}'..='\u{10d6d}',
                    'ğµ¯'..='ğ¶…',
                    'ğº€'..='ğº©',
                    '\u{10eab}'..='\u{10eac}',
                    'ğº°'..='ğº±',
                    'ğ»‚'..='ğ»„',
                    '\u{10efc}'..='ğ¼œ',
                    'ğ¼§'..='ğ¼§',
                    'ğ¼°'..='\u{10f50}',
                    'ğ½°'..='\u{10f85}',
                    'ğ¾°'..='ğ¿„',
                    'ğ¿ '..='ğ¿¶',
                    'ğ‘€€'..='\u{11046}',
                    'ğ‘¦'..='ğ‘µ',
                    '\u{1107f}'..='\u{110ba}',
                    '\u{110c2}'..='\u{110c2}',
                    'ğ‘ƒ'..='ğ‘ƒ¨',
                    'ğ‘ƒ°'..='ğ‘ƒ¹',
                    '\u{11100}'..='\u{11134}',
                    'ğ‘„¶'..='ğ‘„¿',
                    'ğ‘…„'..='ğ‘…‡',
                    'ğ‘…'..='\u{11173}',
                    'ğ‘…¶'..='ğ‘…¶',
                    '\u{11180}'..='ğ‘‡„',
                    '\u{111c9}'..='\u{111cc}',
                    'ğ‘‡'..='ğ‘‡š',
                    'ğ‘‡œ'..='ğ‘‡œ',
                    'ğ‘ˆ€'..='ğ‘ˆ‘',
                    'ğ‘ˆ“'..='\u{11237}',
                    '\u{1123e}'..='\u{11241}',
                    'ğ‘Š€'..='ğ‘Š†',
                    'ğ‘Šˆ'..='ğ‘Šˆ',
                    'ğ‘ŠŠ'..='ğ‘Š',
                    'ğ‘Š'..='ğ‘Š',
                    'ğ‘ŠŸ'..='ğ‘Š¨',
                    'ğ‘Š°'..='\u{112ea}',
                    'ğ‘‹°'..='ğ‘‹¹',
                    '\u{11300}'..='ğ‘Œƒ',
                    'ğ‘Œ…'..='ğ‘ŒŒ',
                    'ğ‘Œ'..='ğ‘Œ',
                    'ğ‘Œ“'..='ğ‘Œ¨',
                    'ğ‘Œª'..='ğ‘Œ°',
                    'ğ‘Œ²'..='ğ‘Œ³',
                    'ğ‘Œµ'..='ğ‘Œ¹',
                    '\u{1133b}'..='ğ‘„',
                    'ğ‘‡'..='ğ‘ˆ',
                    'ğ‘‹'..='\u{1134d}',
                    'ğ‘'..='ğ‘',
                    '\u{11357}'..='\u{11357}',
                    'ğ‘'..='ğ‘£',
                    '\u{11366}'..='\u{1136c}',
                    '\u{11370}'..='\u{11374}',
                    'ğ‘€'..='ğ‘‰',
                    'ğ‘‹'..='ğ‘‹',
                    'ğ‘'..='ğ‘',
                    'ğ‘'..='ğ‘µ',
                    'ğ‘·'..='\u{113c0}',
                    '\u{113c2}'..='\u{113c2}',
                    '\u{113c5}'..='\u{113c5}',
                    '\u{113c7}'..='ğ‘Š',
                    'ğ‘Œ'..='ğ‘“',
                    '\u{113e1}'..='\u{113e2}',
                    'ğ‘€'..='ğ‘‘Š',
                    'ğ‘‘'..='ğ‘‘™',
                    '\u{1145e}'..='ğ‘‘¡',
                    'ğ‘’€'..='ğ‘“…',
                    'ğ‘“‡'..='ğ‘“‡',
                    'ğ‘“'..='ğ‘“™',
                    'ğ‘–€'..='\u{115b5}',
                    'ğ‘–¸'..='\u{115c0}',
                    'ğ‘—˜'..='\u{115dd}',
                    'ğ‘˜€'..='\u{11640}',
                    'ğ‘™„'..='ğ‘™„',
                    'ğ‘™'..='ğ‘™™',
                    'ğ‘š€'..='ğ‘š¸',
                    'ğ‘›€'..='ğ‘›‰',
                    'ğ‘›'..='ğ‘›£',
                    'ğ‘œ€'..='ğ‘œš',
                    '\u{1171d}'..='\u{1172b}',
                    'ğ‘œ°'..='ğ‘œ¹',
                    'ğ‘€'..='ğ‘†',
                    'ğ‘ €'..='\u{1183a}',
                    'ğ‘¢ '..='ğ‘£©',
                    'ğ‘£¿'..='ğ‘¤†',
                    'ğ‘¤‰'..='ğ‘¤‰',
                    'ğ‘¤Œ'..='ğ‘¤“',
                    'ğ‘¤•'..='ğ‘¤–',
                    'ğ‘¤˜'..='ğ‘¤µ',
                    'ğ‘¤·'..='ğ‘¤¸',
                    '\u{1193b}'..='\u{11943}',
                    'ğ‘¥'..='ğ‘¥™',
                    'ğ‘¦ '..='ğ‘¦§',
                    'ğ‘¦ª'..='\u{119d7}',
                    '\u{119da}'..='ğ‘§¡',
                    'ğ‘§£'..='ğ‘§¤',
                    'ğ‘¨€'..='\u{11a3e}',
                    '\u{11a47}'..='\u{11a47}',
                    'ğ‘©'..='\u{11a99}',
                    'ğ‘ª'..='ğ‘ª',
                    'ğ‘ª°'..='ğ‘«¸',
                    'ğ‘¯€'..='ğ‘¯ ',
                    'ğ‘¯°'..='ğ‘¯¹',
                    'ğ‘°€'..='ğ‘°ˆ',
                    'ğ‘°Š'..='\u{11c36}',
                    '\u{11c38}'..='ğ‘±€',
                    'ğ‘±'..='ğ‘±™',
                    'ğ‘±²'..='ğ‘²',
                    '\u{11c92}'..='\u{11ca7}',
                    'ğ‘²©'..='\u{11cb6}',
                    'ğ‘´€'..='ğ‘´†',
                    'ğ‘´ˆ'..='ğ‘´‰',
                    'ğ‘´‹'..='\u{11d36}',
                    '\u{11d3a}'..='\u{11d3a}',
                    '\u{11d3c}'..='\u{11d3d}',
                    '\u{11d3f}'..='\u{11d47}',
                    'ğ‘µ'..='ğ‘µ™',
                    'ğ‘µ '..='ğ‘µ¥',
                    'ğ‘µ§'..='ğ‘µ¨',
                    'ğ‘µª'..='ğ‘¶',
                    '\u{11d90}'..='\u{11d91}',
                    'ğ‘¶“'..='ğ‘¶˜',
                    'ğ‘¶ '..='ğ‘¶©',
                    'ğ‘» '..='ğ‘»¶',
                    '\u{11f00}'..='ğ‘¼',
                    'ğ‘¼’'..='\u{11f3a}',
                    'ğ‘¼¾'..='\u{11f42}',
                    'ğ‘½'..='\u{11f5a}',
                    'ğ‘¾°'..='ğ‘¾°',
                    'ğ’€€'..='ğ’™',
                    'ğ’€'..='ğ’‘®',
                    'ğ’’€'..='ğ’•ƒ',
                    'ğ’¾'..='ğ’¿°',
                    'ğ“€€'..='ğ“¯',
                    '\u{13440}'..='\u{13455}',
                    'ğ“‘ '..='ğ”º',
                    'ğ”€'..='ğ”™†',
                    'ğ–„€'..='ğ–„¹',
                    'ğ– €'..='ğ–¨¸',
                    'ğ–©€'..='ğ–©',
                    'ğ–© '..='ğ–©©',
                    'ğ–©°'..='ğ–ª¾',
                    'ğ–«€'..='ğ–«‰',
                    'ğ–«'..='ğ–«­',
                    '\u{16af0}'..='\u{16af4}',
                    'ğ–¬€'..='\u{16b36}',
                    'ğ–­€'..='ğ–­ƒ',
                    'ğ–­'..='ğ–­™',
                    'ğ–­£'..='ğ–­·',
                    'ğ–­½'..='ğ–®',
                    'ğ–µ€'..='ğ–µ¬',
                    'ğ–µ°'..='ğ–µ¹',
                    'ğ–¹€'..='ğ–¹¿',
                    'ğ–¼€'..='ğ–½Š',
                    '\u{16f4f}'..='ğ–¾‡',
                    '\u{16f8f}'..='ğ–¾Ÿ',
                    'ğ–¿ '..='ğ–¿¡',
                    'ğ–¿£'..='\u{16fe4}',
                    '\u{16ff0}'..='\u{16ff1}',
                    'ğ—€€'..='ğ˜Ÿ·',
                    'ğ˜ €'..='ğ˜³•',
                    'ğ˜³¿'..='ğ˜´ˆ',
                    'ğš¿°'..='ğš¿³',
                    'ğš¿µ'..='ğš¿»',
                    'ğš¿½'..='ğš¿¾',
                    'ğ›€€'..='ğ›„¢',
                    'ğ›„²'..='ğ›„²',
                    'ğ›…'..='ğ›…’',
                    'ğ›…•'..='ğ›…•',
                    'ğ›…¤'..='ğ›…§',
                    'ğ›…°'..='ğ›‹»',
                    'ğ›°€'..='ğ›±ª',
                    'ğ›±°'..='ğ›±¼',
                    'ğ›²€'..='ğ›²ˆ',
                    'ğ›²'..='ğ›²™',
                    '\u{1bc9d}'..='\u{1bc9e}',
                    'ğœ³°'..='ğœ³¹',
                    '\u{1cf00}'..='\u{1cf2d}',
                    '\u{1cf30}'..='\u{1cf46}',
                    '\u{1d165}'..='\u{1d169}',
                    '\u{1d16d}'..='\u{1d172}',
                    '\u{1d17b}'..='\u{1d182}',
                    '\u{1d185}'..='\u{1d18b}',
                    '\u{1d1aa}'..='\u{1d1ad}',
                    '\u{1d242}'..='\u{1d244}',
                    'ğ€'..='ğ‘”',
                    'ğ‘–'..='ğ’œ',
                    'ğ’'..='ğ’Ÿ',
                    'ğ’¢'..='ğ’¢',
                    'ğ’¥'..='ğ’¦',
                    'ğ’©'..='ğ’¬',
                    'ğ’®'..='ğ’¹',
                    'ğ’»'..='ğ’»',
                    'ğ’½'..='ğ“ƒ',
                    'ğ“…'..='ğ”…',
                    'ğ”‡'..='ğ”Š',
                    'ğ”'..='ğ””',
                    'ğ”–'..='ğ”œ',
                    'ğ”'..='ğ”¹',
                    'ğ”»'..='ğ”¾',
                    'ğ•€'..='ğ•„',
                    'ğ•†'..='ğ•†',
                    'ğ•Š'..='ğ•',
                    'ğ•’'..='ğš¥',
                    'ğš¨'..='ğ›€',
                    'ğ›‚'..='ğ›š',
                    'ğ›œ'..='ğ›º',
                    'ğ›¼'..='ğœ”',
                    'ğœ–'..='ğœ´',
                    'ğœ¶'..='ğ',
                    'ğ'..='ğ®',
                    'ğ°'..='ğˆ',
                    'ğŠ'..='ğ¨',
                    'ğª'..='ğŸ‚',
                    'ğŸ„'..='ğŸ‹',
                    'ğŸ'..='ğŸ¿',
                    '\u{1da00}'..='\u{1da36}',
                    '\u{1da3b}'..='\u{1da6c}',
                    '\u{1da75}'..='\u{1da75}',
                    '\u{1da84}'..='\u{1da84}',
                    '\u{1da9b}'..='\u{1da9f}',
                    '\u{1daa1}'..='\u{1daaf}',
                    'ğ¼€'..='ğ¼',
                    'ğ¼¥'..='ğ¼ª',
                    '\u{1e000}'..='\u{1e006}',
                    '\u{1e008}'..='\u{1e018}',
                    '\u{1e01b}'..='\u{1e021}',
                    '\u{1e023}'..='\u{1e024}',
                    '\u{1e026}'..='\u{1e02a}',
                    'ğ€°'..='ğ­',
                    '\u{1e08f}'..='\u{1e08f}',
                    'ğ„€'..='ğ„¬',
                    '\u{1e130}'..='ğ„½',
                    'ğ…€'..='ğ…‰',
                    'ğ…'..='ğ…',
                    'ğŠ'..='\u{1e2ae}',
                    'ğ‹€'..='ğ‹¹',
                    'ğ“'..='ğ“¹',
                    'ğ—'..='ğ—º',
                    'ğŸ '..='ğŸ¦',
                    'ğŸ¨'..='ğŸ«',
                    'ğŸ­'..='ğŸ®',
                    'ğŸ°'..='ğŸ¾',
                    'ğ €'..='ğ£„',
                    '\u{1e8d0}'..='\u{1e8d6}',
                    'ğ¤€'..='ğ¥‹',
                    'ğ¥'..='ğ¥™',
                    'ğ¸€'..='ğ¸ƒ',
                    'ğ¸…'..='ğ¸Ÿ',
                    'ğ¸¡'..='ğ¸¢',
                    'ğ¸¤'..='ğ¸¤',
                    'ğ¸§'..='ğ¸§',
                    'ğ¸©'..='ğ¸²',
                    'ğ¸´'..='ğ¸·',
                    'ğ¸¹'..='ğ¸¹',
                    'ğ¸»'..='ğ¸»',
                    'ğ¹‚'..='ğ¹‚',
                    'ğ¹‡'..='ğ¹‡',
                    'ğ¹‰'..='ğ¹‰',
                    'ğ¹‹'..='ğ¹‹',
                    'ğ¹'..='ğ¹',
                    'ğ¹‘'..='ğ¹’',
                    'ğ¹”'..='ğ¹”',
                    'ğ¹—'..='ğ¹—',
                    'ğ¹™'..='ğ¹™',
                    'ğ¹›'..='ğ¹›',
                    'ğ¹'..='ğ¹',
                    'ğ¹Ÿ'..='ğ¹Ÿ',
                    'ğ¹¡'..='ğ¹¢',
                    'ğ¹¤'..='ğ¹¤',
                    'ğ¹§'..='ğ¹ª',
                    'ğ¹¬'..='ğ¹²',
                    'ğ¹´'..='ğ¹·',
                    'ğ¹¹'..='ğ¹¼',
                    'ğ¹¾'..='ğ¹¾',
                    'ğº€'..='ğº‰',
                    'ğº‹'..='ğº›',
                    'ğº¡'..='ğº£',
                    'ğº¥'..='ğº©',
                    'ğº«'..='ğº»',
                    'ğŸ„°'..='ğŸ…‰',
                    'ğŸ…'..='ğŸ…©',
                    'ğŸ…°'..='ğŸ†‰',
                    'ğŸ¯°'..='ğŸ¯¹',
                    'ğ €€'..='ğª›Ÿ',
                    'ğªœ€'..='ğ«œ¹',
                    'ğ«€'..='ğ« ',
                    'ğ«  '..='ğ¬º¡',
                    'ğ¬º°'..='ğ®¯ ',
                    'ğ®¯°'..='ğ®¹',
                    'ğ¯ €'..='ğ¯¨',
                    'ğ°€€'..='ğ±Š',
                    'ğ±'..='ğ²¯',
                    '\u{e0100}'..='\u{e01ef}',
                ]
            },
            &['\\'..='\\'],
            {
                &[
                    '"'..='"',
                    '\\'..='\\',
                    'b'..='b',
                    'f'..='f',
                    'n'..='n',
                    't'..='t',
                ]
            },
            { &['\0'..='!', '#'..='[', ']'..='\u{10ffff}'] },
        ];
        if let Some(ranges) = CHAR_CLASS_TABLE.get(char_class) {
            ranges
                .binary_search_by(|range| {
                    if c < *range.start() {
                        Ordering::Greater
                    } else if c > *range.end() {
                        Ordering::Less
                    } else {
                        Ordering::Equal
                    }
                })
                .is_ok()
        } else {
            false
        }
    }
}
"#;
        assert_eq!(formatted_code, expected_code);
    }
}
